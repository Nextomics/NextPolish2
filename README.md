# NextPolish2

After the publication of the completed map of human genome, the construction of a telomere-to-telomere (T2T) genome assembly has gradually become a new trend in the field of assembly. A high-quality T2T genome requires not only complete assembly result without any gaps, but also high consensus sequence accuracy and few structural misassemblies. The current T2T genome skeleton structure is generally assembled using high-accuracy PacBio high-fidelity (HiFi) reads, and then using Oxford Nanopore Technologies (ONT) "ultra-long" reads to fill gaps. Although the primary contigs assembled using HiFi reads is very accurate, it still contains some errors, especially in homopolymer or low-complexity microsatellite regions. Besides, the gap filling sequences generated by ONT reads still contains a large number of errors. NextPolish2 can be used to fix these base errors (SNV/Indel) in an assembly. Through the built-in phasing module, it can only correct the error bases while maintaining the original haplotype consistency. Therefore, even in the regions with complex segmental duplications and large tandem repeats, NextPolish2 will still not produce overcorrections. In fact, it can reduce switching errors in the heterozygous region. NextPolish2 is not an upgraded version of NextPolish, but an additional supplement for the pursuit of more accurate genome assembly.

## Table of Contents

- [Installation](#install)
- [General usage](#usage)
- [Algorithm overview](#algorithm)
- [Getting help](#help)
- [Citation](#cite)
- [License](#license)
- [Limitations](#limit)
- [Benchmarking](#benchmark)
- [FAQ](./doc/faq.md)

### <a name="install"></a>Installation

#### Dependencies

`NextPolish2` is written in rust, try below commands (no root required) or refer [here](https://www.rust-lang.org/tools/install) to install `Rust` first.
```sh
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

#### Download and install

```sh
git clone --recursive git@github.com:Nextomics/NextPolish2.git
cd NextPolish2 && cargo build --release
```

#### Test

```sh
cd test && bash hh.sh
```

### <a name="usage"></a>General usage

NextPolish2 takes a genome assembly file, a HiFi mapping file and one or more k-mer database files as input and generates the polished genome.

1. Prepare HiFi mapping file

```sh
# mapping
minimap2 -ax map-hifi -t 5 asm.fa.gz hifi.fasta.gz|samtools sort -o hifi.map.sort.bam
# indexing
samtools index hifi.map.sort.bam
```

2. Prepare k-mer database files. Here we only produce 21-mer and 51-mer databases, you can produce more k-mer databases with different k-mer size

```sh
# produce a 21-mer database
./yak/yak count -o k21.yak -k 21 <(zcat sr.R*.fastq.gz) <(zcat sr.R*.fastq.gz)
# produce a 51-mer database
./yak/yak count -o k51.yak -k 51 <(zcat sr.R*.fastq.gz) <(zcat sr.R*.fastq.gz) 
```

3. Run NextPolish2

```sh
./target/release/nextPolish2 -t 5 hifi.map.sort.bam asm.fa.gz k21.yak k51.yak > asm.np2.fa
```

***Note:*** If your genome is assembled via trio binning. You can set `--model ref`, which means NextPolish2 will output the same haplotype phase blocks as the reference, otherwise it will preferentially output longer haplotype phase blocks. In addition, you can discard reads that have different haplotype with the reference during the mapping procedure, which usually produces a better result.

#### More options

Use `./target/release/nextPolish2 -h` to see options.

### <a name="algorithm"></a>Algorithm overview

Coming soon...

### <a name="help"></a>Getting help

#### Help

   Feel free to raise an issue at the [issue page](https://github.com/Nextomics/NextPolish2/issues/new).

   ***Note:*** Please ask questions on the issue page first. They are also helpful to other users.
#### Contact
   
   For additional help, please send an email to huj\_at\_grandomics\_dot\_com.

### <a name="cite"></a>Citation

Coming soon...

### <a name="license"></a>License

NextPolish2 is only freely available for academic use and other non-commercial use.

### <a name="limit"></a>Limitations

1. NextPolish2 can only correct the regions that are mapped by HiFi reads. For regions without HiFi reads mapping (usually cause by high error rate), NextPolish2 will output original bases, in this case, the results can be optimized by adjusting the mapping parameters.
2. NextPolish2 can only fix some structural misassemblies.

### <a name="benchmark"></a>Benchmarking

Coming soon...

### Star
You can track updates by tab the **Star** button on the upper-right corner at the [github page](https://github.com/Nextomics/NextPolish2).